# Администрирование Linux. ДЗ №3
## Работа с пользователями


## Цель:
> Работа состоит из 2х пунктов. `часть отмеченная "*" не обязательна к выполнению.`
> 1. Первая часть:
>  * Создать нескольких пользователей, задать им пароли, домашние директории и шеллы;
>  * Создать группу admin;
>  * Включить нескольких из ранее созданных пользователей, а также пользователя root, в группу admin;
>  * Запретить всем пользователям, кроме группы admin, логин в систему по SSH в выходные дни (суббота и воскресенье, без учета праздников).
>  * \* С учётом праздничных дней.
>  
>> (Для упрощения проверки можно разрешить парольную аутентификацию по SSH и использовать ssh user@localhost проверяя логин с этой же машины)
> ---
> 2. Вторая часть:
>  * Установить docker;
>  * Дать конкретному пользователю:
>    * права работать с docker (выполнять команды docker ps и т.п.);
>    * \* возможность перезапускать демон docker (systemctl restart docker) не выдавая прав более, чем для этого нужно;
---


## Часть 1

<details>
<summary>Подробности</summary>

---
### 1. Создание нескольких пользователей

Чтобы создать пользователя в Linux используется команда `useradd <опции> <имя пользователя>`, нам необходимо использовать ключи (опции) `-d /home/<имя пользователя>` для указания домашнего каталога пользователя, и ключ `-s <путь до исполнительного файла оболочки>` для указания используемой оболочки для данного пользователя.


Создадим несколько (3) пользователей с указанием домашней директории и путей для bash (в нашем случае). 
Для этого выполним команды 
```
sudo useradd -d /home/test1 -s /bin/bash test1
sudo useradd -d /home/test2 -s /bin/bash test2
sudo useradd -d /home/test3 -s /bin/bash test3
```

Результат выполнения команд (создание пользователей):

![Результат выполнения команд (создание пользователей)](https://sun9-63.userapi.com/FVJdk6u9kEf1M6tzw7bTk4jIjy2AaZjThsCuzw/wYPOeRXBLWc.jpg "Результат выполнения команд (создание пользователей)")


Для добавления паролей выполним команду `sudo passwd <имя пользователя>` для каждого из пользователей.

Всем пользователям был выставлен незамысловатый пароль: "Qwerty".

Результат выполнения команд (смены пароля для пользователей):

![Результат выполнения команд (смены пароля для пользователей)](https://sun9-8.userapi.com/eP-TZAVCCb4HdXljgfinmMSYGUZYcSVlDGcLnQ/BejFRx0ikRM.jpg "Результат выполнения команд (смены пароля для пользователей)")


Далее была добавлена группа `admin` для этого была выполнена команда `sudo groupadd admin`.
Результат добавления группы:

![Результат добавления группы](https://sun9-59.userapi.com/r6Ah5nZYm5ateNeNOg0oo8o6PoIbmoOUA7Rofg/HL15f3SYDrE.jpg "Результат добавления группы")


Далее были добавлены два пользователя *test1* и *test3* в группу `admin` следующими командами:
```
sudo usermod -aG admin test1
sudo usermod -aG admin test3
```


Также, сразу после добавления удостоверимся в этом, введением команды `id <имя пользователя>`.

Результат добавления в группу нескольких пользователей:

![Результат добавления в группу нескольких пользователей](https://sun9-69.userapi.com/QdWYNILNj1I-CLfdCk4UAtaS-BteYJZABVnhqg/UZHu4u1kNL8.jpg "Результат добавления в группу нескольких пользователей")


Необходимо было еще пользователя **root** добавить в эту же группу:

![Результат добавления пользователя root в группу](https://sun9-38.userapi.com/VYmhf3EatCf7224xnl82PZb6yDW8fZ9K_oIPeg/oZ7tLgPAn2Q.jpg "Результат добавления пользователя root в группу")


При попытках добавить ограничение на использование SSH наткнулся на проблему, что в виртуальной машине, которую я использовал для выполнения лаборатоной работы, не установлен весь пакет SSH (а именно демон не работал и его конфигурационных файлов не было), поэтому была выполнена команда установки всего пакета SSH `sudo apt-get install ssh`

После установки полного пакета мне удалось выполнить пробный вход в систему от имени пользователей.


По заданию необходимо было ограничить использование ssh в определенное время:
| **Дн** | **All**  | **test1** | **test2** | **test3** | **root**  | **nikel** |
| -- |:----:| :----:| :----:| :----:| :----:| :----:|
| **Пн** | + | + | + | + | + | + |
| **Вт** | + | + | + | + | + | + |
| **Ср** | + | + | + | + | + | + |
| **Чт** | + | + | + | + | + | + |
| **Пт** | + | + | + | + | + | + |
| **Сб** | - | + | - | + | + | - |
| **Вс** | - | + | - | + | + | - |

> (где `+` означает, что доступ должен быть разрешен.)

-----------------------------
Костыль, и **так лучше не делать**: `но это работает ¯\_(ツ)_/¯`

~~Получается, что в файл `sudo vim /etc/security/time.conf` необходимо дописать~~ 
```
sshd;*;test1|test3|root;Al0000-2400
sshd;*;nikel|test2;Wk0000-2400
```

~~> Исключение почему-то на моей версии Ubuntu не хотел корректно выполняться (потрачено на разнообразные тесты комбинаций с исключениями **"все кроме"** почти 5 часов)~~

~~Также, теперь надо добавить в ***/etc/pam.d/sshd*** после последней строчки, которая **начинается** с `auth` следующий код:~~
```
account    required     pam_time.so
```


Так, ну мы запомнили, что ТАК делать не надо, а вот так надо (см. ниже).


-----------------------------

### Реализация через **pam_script**:

Необходимо первым делом установить pam_script в систему, так как он идет в составе пакета *libpam-script* то для установки используем команду `sudo apt install libpam-script`.

Далее, выполним команду `sudo vim /usr/share/libpam-script/pam_script_acct`, и напишем следующий код:

```bash
#!bin/bash
script="$1"
shift

if groups $PAM_USER | grep admin > /dev/null
then
        exit 0
else
        if [[ $(date +%u) -lt 6 ]]
        then
                exit 0
        else
                exit 1
        fi
fi

if [ ! -e "$script" ]
then
        exit 0
fi
```

Далее выполняем команду `sudo chmod +x /usr/share/libpam-script/pam_script_acct`, чтобы файл стал исполняемым.

Далее, необходимо внести запись в файл `/etc/pam.d/sshd` как показано на рисунке ниже:

![Добавление строки в /etc/pam.d/sshd](https://sun9-39.userapi.com/MKpQqdWPcLQABoxgffahYyRNgMFfriG7uIGqww/sd3gRlR4Ml0.jpg "Добавление строки в /etc/pam.d/sshd")



### Проверочка всего, что было выше сотворено:

Удостоверимся, что всё работает корректно.


Попытка войти в понедельник (рабочий день) под разными пользователями:

![Результат попыток входа](https://sun9-3.userapi.com/LX8rBnn7mcAQgad5U8tVvy53NadJ8ycDqgwXDw/MivZp2Tbtl8.jpg "Попытка войти в понедельник (рабочий день) под разными пользователями")

Попытка войти в субботу (выходной день) под разными пользователями:
![Результат попыток входа](https://sun9-58.userapi.com/gvcQbV8JvnjdT5VfnM36esnd-GgcbDJ8zMHTNQ/tHk5i7riXwk.jpg "Попытка войти в субботу (выходной день) под разными пользователями")

Фууух, на этом многострадальная первая часть завершена... Дальше проще

---

</details>


## Часть 2

<details>
<summary>Подробности</summary>

---
### 1. Установка docker'а


Установка docker'а производилась [по инструкции](https://losst.ru/ustanovka-docker-na-ubuntu-16-04)

Выполнены команды:
```
sudo apt update && sudo apt upgrade
sudo apt install apt-transport-https ca-certificates curl software-properties-common
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable"
sudo apt update && apt-cache policy docker-ce
```

Ну и команда для установки docker'a:
```
sudo apt install -y docker-ce
```

> Чтобы завершить установку осталось добавить нашего пользователя в группу docker. Иначе при запуске утилиты вы будете получать ошибку подключения к сокету.
Выдача прав пользователю ***nikel*** производилась командой: 
```
sudo usermod -aG docker $(whoami)
```
Можно было обойтись командой `sudo usermod -aG docker nikel`, но я выполнил именно команду, приведенную выше.

На данный момент пользователь уже может выполнять перезапуск docker'а командой `sudo systemctl restart docker`, пока что от имени суперпользователя.


Собственно, подтверждение установки docker'а можно считать рисунок, приведенный ниже:
![Версия установленного docker'a](https://sun9-33.userapi.com/z_3QI50H2qYQhhWfCYhO1n9GoBARC6cofTIzQQ/n5IKYib--Ks.jpg "Версия установленного docker'a")


### 2. Выдача прав на работу с docker'ом конкретному пользователю


Чтобы пользовать мог пользоваться основными командами docker'a необходимо установить пакет **docker compose**, для этого необходимо выполнить следующие команды:

```
sudo curl -L "https://github.com/docker/compose/releases/download/1.25.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

Установленная версия docker compose:

![Версия docker compose](https://sun9-30.userapi.com/8iDc9zzioZQ9rd14NVT08mZ9PI4-ieIp8VDs8g/THi0k0gGOfI.jpg "Версия docker compose")


Попробуем выполнить часто используемые команды работы с docker'ом, такие как:
- `docker ps -a`
- `docker images`
- `docker search`


Собственно, подтверждением возможности использования основных команду можно считать рисунок, приведенный ниже:

![Выполнение основных команд Docker'a](https://sun9-72.userapi.com/xvvCHxHb3YpljcxusXxeb-56oOtHFJfv-W4s-w/pMiwGdeYixk.jpg "Выполнение основных команд Docker'a")


Для того, чтобы определенный пользователь мог пользоваться Docker'ом необходимо его дабавить в группу ***docker***, сейчас в группе находится 4 пользователя:

![Список пользователей в группе docker](https://sun1-94.userapi.com/zG1olrL26HRcLFZkxF70Z6H00QlzQi1WmCsfSQ/nzW5GYCegQM.jpg "Список пользователей в группе docker")

Потому что если попытаться выполнить любую команду от имени пользователя, которого нет в списке группы ***docker*** будет получено сообщение с ошибкой, приведенной ниже:

![Ошибка при попытке использования docker'a пользователем, которого нет в группе docker](https://sun9-15.userapi.com/sTnEhL2y0CYMwJ3Br3rHpRysAv9_Ca9mIMCBqA/RlqbM21i_o8.jpg "Ошибка при попытке использования docker'a пользователем, которого нет в группе docker")


На этом вторая часть завершена

---

</details>

## Используемый инструментарий:
- Виртуальная машина под управлением **Ubuntu 18.04.5 LTS**
- GIT (устанавливается командой `sudo apt install git -y`)
- Docker (устанавливается командой `sudo apt install -y docker-ce`) [дополнительная инструкция](https://losst.ru/ustanovka-docker-na-ubuntu-16-04)
- BASH (вроде идет в составе linux, но на всякий случай команда для установки `sudo apt install bash`)
